# ==============================================================================
# Consensus Engine Environment Configuration
# ==============================================================================
# This file contains environment variables for local development and testing.
#
# For GCP deployment configuration and complete environment variable reference:
# See docs/GCP_DEPLOYMENT_ARCHITECTURE.md
#
# Service-specific variable groups:
# - API Service: OpenAI, CORS, Database, Pub/Sub Publisher
# - Worker Service: OpenAI, Database, Pub/Sub Subscriber, Worker-specific
# - Frontend Service: See webapp/.env.example
#
# Usage:
# 1. Copy this file to .env: cp .env.example .env
# 2. Update values as needed for your environment
# 3. Never commit .env to version control
#
# ==============================================================================
# Docker and Cloud Run Deployment Notes
# ==============================================================================
# All environment variables in this file are RUNTIME configuration.
# They can be:
# - Set via .env file for local development
# - Passed as environment variables in docker-compose.yml
# - Configured as Cloud Run environment variables or secrets
# - Injected via Secret Manager in production (recommended for sensitive values)
#
# Build-time configuration:
# - No build-time arguments are required for the Docker images
# - All configuration is done at runtime for maximum flexibility
# - Docker images are environment-agnostic and can be promoted across environments
#
# Cloud Run Secret Management:
# - Store sensitive values (OPENAI_API_KEY, DB_PASSWORD) in Secret Manager
# - Reference secrets in Cloud Run service YAML via secretKeyRef
# - Use IAM service accounts with minimal required permissions
# ==============================================================================

# OpenAI API Configuration
# Required: Your OpenAI API key for authentication
OPENAI_API_KEY=your_api_key_here

# Optional: OpenAI model to use (default: gpt-5.1)
# Recommended: gpt-5.1 for production use
OPENAI_MODEL=gpt-5.1

# Optional: Temperature for model responses (default: 0.7)
# Range: 0.0 to 1.0 (lower = more deterministic, higher = more creative)
# Recommended range: 0.5 to 0.7 for balanced responses
TEMPERATURE=0.7

# ==============================================================================
# Per-Step Configuration
# ==============================================================================
# The Consensus Engine supports per-step model and temperature configuration.
# This allows different models/settings for expansion, review, and aggregation.
# Each step includes its own model, temperature, timeout, and retry configuration.
#
# Version Metadata:
# - All steps use the same schema_version (1.0.0) and prompt_set_version (1.0.0)
# - Version metadata is included in API responses and run outputs
# - See docs/PROMPT_CONTRACTS.md for details on version evolution
# ==============================================================================

# Expansion Step Configuration
# Optional: Model for expansion step (default: gpt-5.1)
EXPAND_MODEL=gpt-5.1

# Optional: Temperature for expansion step (default: 0.7)
# Range: 0.0 to 1.0 (higher encourages more creative proposal generation)
EXPAND_TEMPERATURE=0.7

# Review Step Configuration
# Optional: Model for review step (default: gpt-5.1)
REVIEW_MODEL=gpt-5.1

# Optional: Temperature for review step (default: 0.2)
# Range: 0.0 to 1.0 (lower for more deterministic/consistent reviews)
# Recommended: 0.2 for consistent, focused reviews
REVIEW_TEMPERATURE=0.2

# Aggregation Step Configuration
# Optional: Model for aggregation step (default: gpt-5.1)
# Note: Currently aggregation is deterministic and doesn't use LLM,
# but this is configured for potential future LLM-based aggregation
AGGREGATE_MODEL=gpt-5.1

# Optional: Temperature for aggregation step (default: 0.0)
# Range: 0.0 to 1.0 (0.0 for fully deterministic aggregation)
# Recommended: 0.0 to ensure consistent decision-making
AGGREGATE_TEMPERATURE=0.0

# Persona Configuration
# Optional: Default persona name for reviews (default: GenericReviewer)
DEFAULT_PERSONA_NAME=GenericReviewer

# Optional: Default persona instructions for reviews
# Default: Technical reviewer providing balanced feedback
# DEFAULT_PERSONA_INSTRUCTIONS=You are a technical reviewer...

# Optional: Environment mode (default: development)
# Options: development, production, testing
# Controls logging verbosity and debug features
ENV=development

# ==============================================================================
# CORS Configuration
# ==============================================================================
# Comma-separated list of allowed origins for CORS
# Required for the web frontend to make API requests from different origins
#
# Security Best Practices:
# - NEVER use wildcard (*) - this is a security risk
# - Only add origins you control and trust
# - Use HTTPS in production
# - Be as specific as possible with origins
#
# Examples:
# - Local development (Vite default): http://localhost:5173
# - Multiple local ports: http://localhost:5173,http://localhost:3000
# - Staging: https://staging.example.com
# - Production: https://app.example.com
# - Multiple environments: https://app.example.com,https://staging.example.com
#
# Default: http://localhost:5173 (Vite dev server)
# ==============================================================================
CORS_ORIGINS=http://localhost:5173

# Optional: Comma-separated list of allowed CORS headers (default: *)
# For production, specify explicit headers for better security:
# CORS_ALLOW_HEADERS=Content-Type,Authorization,X-Request-ID,X-Schema-Version,X-Prompt-Set-Version
#
# Common headers:
# - Content-Type: Required for JSON requests
# - Authorization: Required for Bearer token authentication (IAM/IAP)
# - X-Request-ID: Request tracking header
# - X-Schema-Version: API schema version header
# - X-Prompt-Set-Version: Prompt set version header
#
# Default: * (allow all headers - acceptable for development, restrict in production)
CORS_ALLOW_HEADERS=*

# Database Configuration
# Optional: Use Cloud SQL Python Connector (default: false)
# Set to true for Cloud Run deployments with Cloud SQL
USE_CLOUD_SQL_CONNECTOR=false

# Optional: Cloud SQL instance connection name (required if USE_CLOUD_SQL_CONNECTOR=true)
# Format: project:region:instance (e.g., my-project:us-central1:my-instance)
# DB_INSTANCE_CONNECTION_NAME=your-project:us-central1:your-instance

# Optional: Database name (default: consensus_engine)
DB_NAME=consensus_engine

# Optional: Database user (default: postgres)
DB_USER=postgres

# Optional: Database password (not used with IAM auth)
# Required for local development or when DB_IAM_AUTH=false
DB_PASSWORD=postgres

# Optional: Database host for local connections (default: localhost)
DB_HOST=localhost

# Optional: Database port for local connections (default: 5432)
DB_PORT=5432

# Optional: Use IAM authentication with Cloud SQL Connector (default: false)
# When true, no password is needed but service account must have cloudsql.client role
DB_IAM_AUTH=false

# Optional: Database connection pool size (default: 5)
# Range: 1-100
DB_POOL_SIZE=5

# Optional: Maximum overflow connections beyond pool size (default: 10)
# Range: 0-100
DB_MAX_OVERFLOW=10

# Optional: Connection pool timeout in seconds (default: 30)
# Range: 1-300
DB_POOL_TIMEOUT=30

# Optional: Connection pool recycle time in seconds (default: 3600)
# Range: 60-7200
# Connections older than this are recycled
DB_POOL_RECYCLE=3600

# ==============================================================================
# Google Cloud Pub/Sub Configuration
# ==============================================================================
# Pub/Sub is used for asynchronous job processing.
# API service publishes job messages, worker service consumes them.
#
# For Cloud deployment, see docs/GCP_DEPLOYMENT_ARCHITECTURE.md
# ==============================================================================

# Optional: Google Cloud project ID for Pub/Sub (required for production)
# Example: my-project-123
# PUBSUB_PROJECT_ID=your-project-id

# Optional: Pub/Sub topic name for job queue (default: consensus-engine-jobs)
# Used by API service to publish jobs
PUBSUB_TOPIC=consensus-engine-jobs

# Optional: Pub/Sub subscription name (default: consensus-engine-jobs-sub)
# Used by worker service to consume jobs
PUBSUB_SUBSCRIPTION=consensus-engine-jobs-sub

# Optional: Path to service account JSON credentials file
# Required for local development with real Pub/Sub
# Not needed when using Application Default Credentials (ADC) on Cloud Run/GCE
# PUBSUB_CREDENTIALS_FILE=/path/to/credentials.json

# Optional: Pub/Sub emulator host for local testing (default: none)
# Example: localhost:8085
# When set, the API will connect to the emulator instead of production Pub/Sub
# PUBSUB_EMULATOR_HOST=localhost:8085

# Optional: Enable mock Pub/Sub publisher for testing (default: false)
# When true, uses a no-op publisher that logs messages without sending to Pub/Sub
# Useful for local development without emulator or credentials
PUBSUB_USE_MOCK=false

# ==============================================================================
# Worker Configuration (Pipeline Worker Only)
# ==============================================================================
# These settings control the background worker that processes jobs from Pub/Sub.
# Only required if running the pipeline worker service.
#
# For worker deployment, see docs/WORKER_DEPLOYMENT.md
# ==============================================================================

# Optional: Maximum concurrent message handlers (default: 10)
# Range: 1-1000
# Controls how many jobs the worker processes simultaneously
WORKER_MAX_CONCURRENCY=10

# Optional: Pub/Sub ack deadline in seconds (default: 600)
# Range: 10-600 (This is a hard limit in Google Cloud Pub/Sub)
# How long worker has to process a message before Pub/Sub redelivers it.
# The worker must extend the deadline for jobs that might exceed this duration.
WORKER_ACK_DEADLINE_SECONDS=600

# Optional: Per-step timeout in seconds (default: 300)
# Range: 10-1800
# Maximum time allowed for each pipeline step (expand, review, aggregate)
WORKER_STEP_TIMEOUT_SECONDS=300

# Optional: Overall job timeout in seconds (default: 540)
# Range: 60-7200
# Maximum time allowed for entire job processing.
# WARNING: Setting this > WORKER_ACK_DEADLINE_SECONDS without ack extension
# in the worker code will cause message redelivery and duplicate processing.
WORKER_JOB_TIMEOUT_SECONDS=540

# Optional: Maximum retries per persona review (default: 3)
# Range: 0-10
# How many times to retry a failed persona review before giving up
MAX_RETRIES_PER_PERSONA=3

# Optional: Initial retry backoff in seconds (default: 1.0)
# Range: 0.1-60.0
# Initial delay before first retry
RETRY_INITIAL_BACKOFF_SECONDS=1.0

# Optional: Retry backoff multiplier (default: 2.0)
# Range: 1.0-10.0
# Multiplier for exponential backoff (delay = initial * multiplier^attempt)
RETRY_BACKOFF_MULTIPLIER=2.0

# ==============================================================================
# API Validation Configuration
# ==============================================================================
# These limits enforce data quality and prevent malformed or malicious inputs.
# All validations occur at the API boundary before LLM calls.
# Exceeding limits results in 422 Unprocessable Entity errors.
#
# Version Tracking:
# - Validation limits are independent of schema/prompt versions
# - Changes to these limits do not require version bumps
# - Limits apply uniformly across all API endpoints under /v1
#
# Tuning Guidelines:
# - Increase limits cautiously to avoid excessive LLM costs
# - Monitor validation error rates to identify if limits are too strict
# - Consider prompt complexity when setting context limits
# - See docs/PROMPT_CONTRACTS.md for version evolution guidance
# ==============================================================================

# Optional: Maximum character length for idea text (default: 10000)
# Range: 100-100000
# Ideas must also contain 1-10 sentences
MAX_IDEA_LENGTH=10000

# Optional: Maximum character length for extra_context (default: 50000)
# Range: 100-500000
# Applies to both string and JSON formats
MAX_EXTRA_CONTEXT_LENGTH=50000

# Optional: Maximum character length for edited_proposal in revision requests (default: 100000)
# Range: 1000-1000000
# Applies to both string and JSON formats
MAX_EDITED_PROPOSAL_LENGTH=100000

# Optional: Maximum character length for edit_notes in revision requests (default: 10000)
# Range: 100-100000
MAX_EDIT_NOTES_LENGTH=10000

# Optional: Minimum number of personas for review (default: 1)
# Range: 1-10
MIN_PERSONA_COUNT=1

# Optional: Maximum number of personas for review (default: 10)
# Range: 1-20
MAX_PERSONA_COUNT=10

# ==============================================================================
# Service-Specific Environment Variable Summary
# ==============================================================================
# For complete deployment requirements, see docs/GCP_DEPLOYMENT_ARCHITECTURE.md
#
# API Service (FastAPI Backend):
# Required:
#   - OPENAI_API_KEY (from Secret Manager in production)
#   - PUBSUB_PROJECT_ID (for production)
#   - DB_INSTANCE_CONNECTION_NAME (for Cloud SQL)
#   - DB_NAME, DB_USER
#   - USE_CLOUD_SQL_CONNECTOR=true (for Cloud SQL)
#   - DB_IAM_AUTH=true (recommended)
# Optional:
#   - OPENAI_MODEL, TEMPERATURE, EXPAND_*, REVIEW_*, AGGREGATE_*
#   - CORS_ORIGINS, CORS_ALLOW_HEADERS
#   - PUBSUB_TOPIC (default: consensus-engine-jobs)
#   - DB_POOL_SIZE, DB_MAX_OVERFLOW, DB_POOL_TIMEOUT, DB_POOL_RECYCLE
#   - ENV (development, production, testing)
#   - MAX_IDEA_LENGTH, MAX_EXTRA_CONTEXT_LENGTH, etc.
#
# Worker Service (Pipeline Worker):
# Required:
#   - OPENAI_API_KEY (from Secret Manager in production)
#   - PUBSUB_PROJECT_ID (for production)
#   - PUBSUB_SUBSCRIPTION (default: consensus-engine-jobs-sub)
#   - DB_INSTANCE_CONNECTION_NAME (for Cloud SQL)
#   - DB_NAME, DB_USER
#   - USE_CLOUD_SQL_CONNECTOR=true (for Cloud SQL)
#   - DB_IAM_AUTH=true (recommended)
# Optional:
#   - OPENAI_MODEL, TEMPERATURE, EXPAND_*, REVIEW_*
#   - WORKER_MAX_CONCURRENCY, WORKER_ACK_DEADLINE_SECONDS
#   - WORKER_STEP_TIMEOUT_SECONDS, WORKER_JOB_TIMEOUT_SECONDS
#   - MAX_RETRIES_PER_PERSONA, RETRY_*
#   - ENV (development, production, testing)
#
# Frontend Service (React + Vite):
# See webapp/.env.example for frontend-specific variables
# Required:
#   - VITE_API_BASE_URL (API endpoint URL)
# Optional:
#   - VITE_APP_TITLE
#
# Local Development (all services):
# Required:
#   - OPENAI_API_KEY
#   - DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD (for local PostgreSQL)
# Optional:
#   - PUBSUB_EMULATOR_HOST (if using emulator)
#   - PUBSUB_USE_MOCK=true (if skipping Pub/Sub)
#   - ENV=development
#
# ==============================================================================
